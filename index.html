<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>VK ID: Manual Exchange</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 40px; background: #f0f2f5; text-align: center; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: inline-block; min-width: 320px; }
        .btn { background: #0077ff; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; font-weight: bold; }
        #log { text-align: left; background: #222; color: #00ff00; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 12px; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="container">
    <h2>Авторизация без SDK</h2>
    <div id="ui-box">
        <button id="login-btn" class="btn">Войти через VK</button>
    </div>
    <div id="log">Ожидание действий...</div>
</div>

<script>
    const APP_ID = '54421608';
    const REDIRECT_URI = 'https://artmotika.github.io/';
    const logEl = document.getElementById('log');

    function print(msg) { logEl.innerText += '\n> ' + msg; console.log(msg); }

    // 1. Генерация PKCE
    async function getPKCE() {
        const verifier = Array.from(crypto.getRandomValues(new Uint8Array(32)))
            .map(b => 'abcdefghijklmnopqrstuvwxyz0123456789'[b % 36]).join('');
        const encoder = new TextEncoder();
        const hash = await crypto.subtle.digest('SHA-256', encoder.encode(verifier));
        const challenge = btoa(String.fromCharCode(...new Uint8Array(hash)))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        return { verifier, challenge };
    }

    // ШАГ 1: Формирование GET-запроса
    document.getElementById('login-btn').onclick = async () => {
        const pkce = await getPKCE();
        const state = Math.random().toString(36).substring(2, 12);

        // Сохраняем verifier для второго шага
        sessionStorage.setItem('vk_verifier', pkce.verifier);
        sessionStorage.setItem('vk_state', state);

        const url = new URL('https://id.vk.com/authorize');
        url.searchParams.set('response_type', 'code');
        url.searchParams.set('client_id', APP_ID);
        url.searchParams.set('redirect_uri', REDIRECT_URI);
        url.searchParams.set('state', state);
        url.searchParams.set('code_challenge', pkce.challenge);
        url.searchParams.set('code_challenge_method', 's256');
        url.searchParams.set('scope', 'email');

        print("Перенаправление на VK...");
        window.location.href = url.toString();
    };

    // ШАГ 2: Обработка ответа и обмен
    async function handleResponse() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');

        // ВНИМАНИЕ: Проверяем, не прислал ли VK нам device_id в URL
        let deviceId = params.get('device_id');

        if (!code) return;

        print("Код получен. Проверяем параметры...");

        const verifier = sessionStorage.getItem('vk_verifier');
        const savedState = sessionStorage.getItem('vk_state');

        if (state !== savedState) {
            print("Ошибка: State не совпадает!");
            return;
        }

        // Если VK не прислал device_id в URL, используем запасной вариант
        if (!deviceId) {
            print("device_id не найден в URL, используем временный...");
            deviceId = 'static_device_id_12345';
        }

        print(`Используем device_id: ${deviceId}`);

        try {
            print("Запрос на обмен токена (POST /oauth2/auth)...");

            const response = await fetch('https://id.vk.com/oauth2/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    code_verifier: verifier,
                    client_id: APP_ID,
                    device_id: deviceId,
                    redirect_uri: REDIRECT_URI
                })
            });

            const data = await response.json();

            if (data.access_token) {
                print("УСПЕХ! Токен получен.");
                await fetchUserInfo(data.access_token);
            } else {
                print(`ОШИБКА: ${data.error_description || data.error}`);
            }
        } catch (e) {
            print("Ошибка сети (CORS): " + e.message);
            print("Примечание: Прямой обмен токена из браузера может блокироваться VK по соображениям безопасности (CORS).");
        }
    }

    async function fetchUserInfo(token) {
        const res = await fetch('https://id.vk.com/oauth2/user_info', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ access_token: token, client_id: APP_ID })
        });
        const user = await res.json();
        document.getElementById('ui-box').innerHTML = `
            <div style="text-align:left; background:#e7f3ff; padding:15px; border-radius:8px; color:#000">
                <b>${user.user.first_name} ${user.user.last_name}</b><br>
                ID: ${user.user.user_id}
            </div>
        `;
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    handleResponse();
</script>

</body>
</html>