<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Yandex ID: Full Data Explorer</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f6f6f6; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 30px rgba(0,0,0,0.1); width: 100%; max-width: 600px; text-align: center; }
        .btn-yandex { background: #fc3f1d; color: white; padding: 14px 25px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; transition: background 0.2s; }
        .btn-yandex:hover { background: #e3391a; }
        #log { text-align: left; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 12px; font-family: monospace; white-space: pre-wrap; overflow-y: auto; max-height: 200px; }
        .user-card { margin-top: 20px; text-align: left; border: 1px solid #ddd; border-radius: 12px; padding: 20px; display: none; }
        .user-card img { width: 80px; height: 80px; border-radius: 50%; float: left; margin-right: 20px; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 6px; font-size: 12px; overflow-x: auto; clear: both; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: #ff0000;">Yandex ID Explorer</h2>
    <div id="ui-box">
        <button id="login-btn" class="btn-yandex">Войти через Яндекс</button>
    </div>

    <div id="user-card" class="user-card">
        <img id="avatar" src="" alt="Avatar">
        <h3 id="user-name" style="margin: 0;"></h3>
        <p id="user-id" style="color: #666;"></p>
        <div style="clear: both;"></div>
        <p><strong>Полный JSON профиля:</strong></p>
        <pre id="raw-json"></pre>
        <button onclick="location.href=location.pathname" style="margin-top: 10px; cursor: pointer;">Выйти</button>
    </div>

    <div id="log">Ожидание инициации...</div>
</div>

<script>
    const CLIENT_ID = 'ВАШ_CLIENT_ID_ЯНДЕКСА'; // Замените на ваш ID
    const REDIRECT_URI = 'https://artmotika.github.io/';

    const logEl = document.getElementById('log');
    function log(msg) { logEl.innerText += `\n> ${msg}`; console.log(msg); }

    // --- 1. PKCE ГЕНЕРАЦИЯ ---
    async function getPKCE() {
        const verifier = Array.from(crypto.getRandomValues(new Uint8Array(32)))
            .map(b => 'abcdefghijklmnopqrstuvwxyz0123456789'[b % 36]).join('');
        const encoder = new TextEncoder();
        const hash = await crypto.subtle.digest('SHA-256', encoder.encode(verifier));
        const challenge = btoa(String.fromCharCode(...new Uint8Array(hash)))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        return { verifier, challenge };
    }

    // --- ШАГ 1: РЕДИРЕКТ ---
    document.getElementById('login-btn').onclick = async () => {
        const pkce = await getPKCE();
        const state = Math.random().toString(36).substring(2, 12);

        sessionStorage.setItem('ya_verifier', pkce.verifier);
        sessionStorage.setItem('ya_state', state);

        const url = new URL('https://oauth.yandex.ru/authorize');
        url.searchParams.set('response_type', 'code');
        url.searchParams.set('client_id', CLIENT_ID);
        url.searchParams.set('redirect_uri', REDIRECT_URI);
        url.searchParams.set('state', state);
        url.searchParams.set('code_challenge', pkce.challenge);
        url.searchParams.set('code_challenge_method', 'S256');

        log("Переход на Яндекс для авторизации...");
        window.location.href = url.toString();
    };

    // --- ШАГ 2: ОБРАБОТКА CALLBACK ---
    async function handleResponse() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');

        if (!code) return;

        log("Код получен. Начинаем обмен на токен...");
        document.getElementById('ui-box').style.display = 'none';

        const verifier = sessionStorage.getItem('ya_verifier');
        const savedState = sessionStorage.getItem('ya_state');

        if (state !== savedState) {
            log("Ошибка: State не совпадает!");
            return;
        }

        try {
            // ВНИМАНИЕ: Запрос на токен в Яндексе часто требует CORS-прокси на фронтенде
            // или выполнения запроса на Java-бэкенде.
            const response = await fetch('https://oauth.yandex.ru/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    client_id: CLIENT_ID,
                    code_verifier: verifier
                })
            });

            const tokenData = await response.json();

            if (tokenData.access_token) {
                log("Токен успешно получен. Запрашиваем инфо...");
                await fetchUserInfo(tokenData.access_token);
            } else {
                log(`Ошибка Яндекса: ${tokenData.error_description || tokenData.error}`);
            }
        } catch (e) {
            log("Ошибка сети (CORS): Запрос заблокирован браузером.");
            log("Для OAuth Яндекса на GitHub Pages рекомендуется использовать Java-бэкенд для этого шага.");
        }
    }

    // --- ШАГ 3: ПОЛУЧЕНИЕ ИНФО О ПОЛЬЗОВАТЕЛЕ ---
    async function fetchUserInfo(token) {
        try {
            const res = await fetch(`https://login.yandex.ru/info?format=json`, {
                headers: { 'Authorization': `OAuth ${token}` }
            });

            const userData = await res.json();
            renderUser(userData);
        } catch (e) {
            log("Ошибка при получении данных: " + e.message);
        }
    }

    function renderUser(user) {
        document.getElementById('user-card').style.display = 'block';
        document.getElementById('user-name').innerText = user.real_name || user.display_name;
        document.getElementById('user-id').innerText = `Yandex ID: ${user.id}`;

        // Яндекс отдает ID аватарки, строим URL
        if (user.default_avatar_id) {
            document.getElementById('avatar').src = `https://avatars.yandex.net/get-yapic/${user.default_avatar_id}/islands-200`;
        }

        document.getElementById('raw-json').textContent = JSON.stringify(user, null, 2);
        window.history.replaceState({}, document.title, window.location.pathname);
        log("Все данные получены успешно!");
    }

    handleResponse();
</script>

</body>
</html>