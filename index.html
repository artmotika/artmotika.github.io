<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VK ID Manual Auth (No SDK)</title>
    <style>
        body { font-family: -apple-system, system-ui, "Helvetica Neue", Roboto, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f2f5; margin: 0; }
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .btn-vk { background-color: #0077ff; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; text-decoration: none; display: inline-block; transition: background 0.2s; }
        .btn-vk:hover { background-color: #0066ee; }
        #user-info { display: none; margin-top: 20px; text-align: left; border-top: 1px solid #eee; padding-top: 20px; }
        #user-info img { width: 80px; height: 80px; border-radius: 50%; display: block; margin: 0 auto 15px; }
        pre { background: #f8f8f8; padding: 10px; font-size: 12px; overflow-x: auto; border-radius: 4px; }
        .status { font-size: 14px; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>VK ID Manual</h2>
    <div id="app-content">
        <p class="status" id="status">Нажмите кнопку для входа</p>
        <button id="login-btn" class="btn-vk">Войти через VK ID</button>
    </div>

    <div id="user-info">
        <img id="avatar" src="" alt="">
        <div style="text-align: center; font-weight: bold; margin-bottom: 10px;" id="full-name"></div>
        <div class="status">Данные из UserInfo:</div>
        <pre id="raw-data"></pre>
        <button onclick="location.href='https://artmotika.github.io/'" style="margin-top:10px; width:100%; cursor:pointer;">Выйти / Сбросить</button>
    </div>
</div>

<script>
    const CLIENT_ID = '54421608';
    const REDIRECT_URI = 'https://artmotika.github.io/';

    // 1. Генерация корректного device_id (только буквы и цифры, 16 символов)
    function getDeviceId() {
        let id = localStorage.getItem('vk_device_id');
        if (!id) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            id = Array.from(array).map(b => chars[b % chars.length]).join('');
            localStorage.setItem('vk_device_id', id);
        }
        return id;
    }

    // Вспомогательные функции для PKCE
    function generateRandomString(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const array = new Uint8Array(length);
        crypto.getRandomValues(array);
        return Array.from(array).map(b => chars[b % chars.length]).join('');
    }

    async function generateCodeChallenge(verifier) {
        const encoder = new TextEncoder();
        const data = encoder.encode(verifier);
        const digest = await crypto.subtle.digest('SHA-256', data);
        return btoa(String.fromCharCode(...new Uint8Array(digest)))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // --- ОСНОВНАЯ ЛОГИКА ---

    const loginBtn = document.getElementById('login-btn');
    const statusText = document.getElementById('status');

    // Шаг 1: Подготовка и Редирект
    loginBtn.onclick = async () => {
        const state = generateRandomString(32);
        const codeVerifier = generateRandomString(64);
        const codeChallenge = await generateCodeChallenge(codeVerifier);
        const deviceId = getDeviceId();

        // Сохраняем всё необходимое для второго этапа
        sessionStorage.setItem('vk_state', state);
        sessionStorage.setItem('vk_code_verifier', codeVerifier);

        const params = new URLSearchParams({
            response_type: 'code',
            client_id: CLIENT_ID,
            redirect_uri: REDIRECT_URI,
            state: state,
            code_challenge: codeChallenge,
            code_challenge_method: 's256',
            scope: 'email',
            device_id: deviceId, // Передаем строго здесь
            v: '2.6.2'
        });

        window.location.href = `https://id.vk.com/authorize?${params.toString()}`;
    };

    // Шаг 2: Обработка возврата
    async function handleAuthCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');

        const savedState = sessionStorage.getItem('vk_state');
        const codeVerifier = sessionStorage.getItem('vk_code_verifier');
        const deviceId = getDeviceId(); // Берем тот же ID из localStorage

        if (!code) return;

        if (state !== savedState) {
            statusText.innerText = "Ошибка: state не совпадает";
            return;
        }

        statusText.innerText = "Обмениваем код на токен...";
        loginBtn.style.display = 'none';

        try {
            // Формируем тело запроса строго по спецификации
            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                code_verifier: codeVerifier,
                client_id: CLIENT_ID,
                device_id: deviceId, // Должен быть 1-в-1 как в первом запросе
                redirect_uri: REDIRECT_URI
            });

            const response = await fetch('https://id.vk.com/oauth2/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: body.toString()
            });

            const data = await response.json();

            if (data.access_token) {
                // Шаг 3: Получение User Info
                const userResponse = await fetch('https://id.vk.com/oauth2/user_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        access_token: data.access_token,
                        client_id: CLIENT_ID
                    })
                });

                const userData = await userResponse.json();
                displayUser(userData.user, data.access_token);
            } else {
                statusText.innerText = `Ошибка API: ${data.error_description || data.error}`;
                console.error('Ошибка VK:', data);
            }
        } catch (err) {
            statusText.innerText = "Ошибка сети (CORS?): " + err.message;
        }
    }

    function displayUser(user, token) {
        document.getElementById('app-content').style.display = 'none';
        const info = document.getElementById('user-info');
        info.style.display = 'block';
        document.getElementById('avatar').src = user.avatar;
        document.getElementById('full-name').innerText = `${user.first_name} ${user.last_name}`;
        document.getElementById('raw-data').textContent = JSON.stringify(user, null, 2);
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    handleAuthCallback();
</script>

</body>
</html>