<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>VK ID: Full User Data Explorer</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 600px; margin: 0 auto; }
        .btn { background: #0077ff; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; font-weight: bold; width: 100%; font-size: 16px; }
        .btn:hover { background: #0066ee; }
        #log { text-align: left; background: #222; color: #00ff00; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 11px; white-space: pre-wrap; max-height: 150px; overflow-y: auto; }

        /* Стили для карточки пользователя */
        .user-card { text-align: left; background: #fff; border: 1px solid #e7e8ec; border-radius: 12px; margin-top: 20px; overflow: hidden; }
        .user-header { display: flex; align-items: center; padding: 20px; background: #fafbfc; border-bottom: 1px solid #e7e8ec; }
        .user-header img { width: 64px; height: 64px; border-radius: 50%; margin-right: 15px; background: #eee; }
        .user-header h3 { margin: 0; font-size: 18px; }
        .user-data { padding: 20px; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 8px; font-size: 13px; overflow-x: auto; border: 1px solid #ddd; }
        .label { font-weight: bold; color: #555; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2>VK ID API Explorer</h2>
    <div id="ui-box">
        <button id="login-btn" class="btn">Войти через VK ID</button>
    </div>
    <div id="log">Ожидание авторизации...</div>
</div>

<script>
    const APP_ID = '54421608';
    const REDIRECT_URI = 'https://artmotika.github.io/';
    const logEl = document.getElementById('log');

    function print(msg) {
        const t = new Date().toLocaleTimeString();
        logEl.innerText += `\n[${t}] ${msg}`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function getPKCE() {
        const verifier = Array.from(crypto.getRandomValues(new Uint8Array(32)))
            .map(b => 'abcdefghijklmnopqrstuvwxyz0123456789'[b % 36]).join('');
        const encoder = new TextEncoder();
        const hash = await crypto.subtle.digest('SHA-256', encoder.encode(verifier));
        const challenge = btoa(String.fromCharCode(...new Uint8Array(hash)))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        return { verifier, challenge };
    }

    document.getElementById('login-btn').onclick = async () => {
        const pkce = await getPKCE();
        const state = Math.random().toString(36).substring(2, 12);

        sessionStorage.setItem('vk_verifier', pkce.verifier);
        sessionStorage.setItem('vk_state', state);

        const url = new URL('https://id.vk.com/authorize');
        url.searchParams.set('response_type', 'code');
        url.searchParams.set('client_id', APP_ID);
        url.searchParams.set('redirect_uri', REDIRECT_URI);
        url.searchParams.set('state', state);
        url.searchParams.set('code_challenge', pkce.challenge);
        url.searchParams.set('code_challenge_method', 's256');

        // Добавляем vkid.personal_info для получения расширенных данных
        url.searchParams.set('scope', 'email vkid.personal_info');

        print("Перенаправление на VK ID...");
        window.location.href = url.toString();
    };

    async function handleResponse() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        const deviceId = params.get('device_id') || 'static_dev_id_' + Math.floor(Math.random() * 10000);

        if (!code) return;

        print("Код получен. Начинаем обмен...");
        const verifier = sessionStorage.getItem('vk_verifier');
        const savedState = sessionStorage.getItem('vk_state');

        if (state !== savedState) {
            print("Ошибка: Неверный state!");
            return;
        }

        try {
            const response = await fetch('https://id.vk.com/oauth2/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    code_verifier: verifier,
                    client_id: APP_ID,
                    device_id: deviceId,
                    redirect_uri: REDIRECT_URI
                })
            });

            const data = await response.json();

            if (data.access_token) {
                print("Токен получен успешно.");
                await fetchUserInfo(data.access_token);
            } else {
                print(`Ошибка обмена: ${data.error_description || data.error}`);
            }
        } catch (e) {
            print("Сетевая ошибка: " + e.message);
        }
    }

    async function fetchUserInfo(token) {
        print("Запрашиваем данные пользователя...");
        try {
            const res = await fetch('https://id.vk.com/oauth2/user_info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ access_token: token, client_id: APP_ID })
            });

            const fullResponse = await res.json();
            const user = fullResponse.user;

            // Выводим данные красиво на страницу
            document.getElementById('ui-box').innerHTML = `
                <div class="user-card">
                    <div class="user-header">
                        <img src="${user.avatar || ''}" alt="Avatar">
                        <div>
                            <h3>${user.first_name} ${user.last_name}</h3>
                            <small>ID: ${user.user_id}</small>
                        </div>
                    </div>
                    <div class="user-data">
                        <span class="label">Полный JSON ответ:</span>
                        <pre>${JSON.stringify(fullResponse, null, 2)}</pre>
                        <button onclick="location.href='${REDIRECT_URI}'" class="btn" style="margin-top:15px; background:#f0f2f5; color:#555;">Очистить</button>
                    </div>
                </div>
            `;

            print("Все данные отображены.");
            window.history.replaceState({}, document.title, window.location.pathname);

        } catch (e) {
            print("Ошибка при получении userInfo: " + e.message);
        }
    }

    handleResponse();
</script>

</body>
</html>